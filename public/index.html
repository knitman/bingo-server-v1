<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<title>BINGO TV</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body{
  background:radial-gradient(circle,#ffd000,#ff7a00);
  font-family:Arial;
  text-align:center;
  color:#000;
}

/* ÎœÎµÎ³Î¬Î»Î· Î¼Ï€Î¬Î»Î± 4K */
#number{
  width:400px;
  height:400px;
  border-radius:50%;
  background:white;
  font-size:200px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin:20px auto;
  transition: transform 0.3s ease;
}

/* Zoom animation */
#number.zoom {
  transform: scale(1.25);
}

.controls button{
  padding:15px 25px;
  font-size:22px;
  margin:5px;
}

#drawn{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:10px;
}

/* ÎœÎ¹ÎºÏÎ­Ï‚ Î¼Ï€Î¬Î»ÎµÏ‚ 4K */
.ball{
  width:90px;
  height:90px;
  border-radius:50%;
  background:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  font-size:32px;
}

audio { display:none; }

/* Î Î¯Î½Î±ÎºÎ±Ï‚ Ï€Î±Î¹ÎºÏ„ÏÎ½ */
#playersContainer{
  max-width:900px;
  margin:20px auto;
  text-align:left;
  background:rgba(255,255,255,0.8);
  padding:15px;
  border-radius:12px;
}
#playersContainer h2{
  margin-top:0;
}
#playersTable{
  width:100%;
  border-collapse:collapse;
  font-size:18px;
}
#playersTable th, #playersTable td{
  padding:6px 8px;
  border-bottom:1px solid #ccc;
}
#playersTable th{
  background:#f0f0f0;
}
.winnerRow{
  background:#c8e6c9;
  font-weight:bold;
}
</style>
</head>

<body>

<h1>BINGO ÎšÎ›Î—Î¡Î©Î£Î—</h1>

<div id="number">â€“</div>

<audio id="sound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>

<div class="controls">
  <button onclick="startAuto()">AUTO</button>
  <button onclick="stopAuto()">STOP</button>
  <button onclick="resetGame()">RESET</button>
</div>

<div id="drawn"></div>

<div id="playersContainer">
  <h2>Î ÏÏŒÎ¿Î´Î¿Ï‚ Ï€Î±Î¹ÎºÏ„ÏÎ½</h2>
  <table id="playersTable">
    <thead>
      <tr>
        <th>Î Î±Î¯ÎºÏ„Î·Ï‚</th>
        <th>Î•Ï€Î¹Ï„Ï…Ï‡Î¯ÎµÏ‚</th>
        <th>Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ</th>
        <th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
      </tr>
    </thead>
    <tbody id="playersBody">
      <!-- Î˜Î± Î³ÎµÎ¼Î¯ÏƒÎµÎ¹ Î±Ï€ÏŒ JS -->
    </tbody>
  </table>
</div>

<hr>
<h3>Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÎ¿Ï…Ï€Î¿Î½Î¹Î¿Ï</h3>
<input id="name" placeholder="ÎŒÎ½Î¿Î¼Î±">
<button onclick="createTicket()">QR</button><br>
<canvas id="qr"></canvas>

<script>
let auto = null;

/* === WebSocket === */
const wsProtocol = location.protocol === "https:" ? "wss://" : "ws://";
const ws = new WebSocket(wsProtocol + location.host);

ws.onmessage = (msg) => {
  const data = JSON.parse(msg.data);

  if (data.type === "state") {
    if (data.drawn && data.drawn.length > 0) {
      const last = data.drawn[data.drawn.length - 1];
      show(last, data.drawn);
    }
    if (data.players) renderPlayers(data.players);
  }

  if (data.type === "number") {
    show(data.number, data.drawn);
    if (data.players) renderPlayers(data.players);
  }

  if (data.type === "players") {
    if (data.players) renderPlayers(data.players);
  }

  if (data.type === "bingo") {
    alert("ğŸ‰ " + (data.name || "ÎšÎ¬Ï€Î¿Î¹Î¿Ï‚") + " Ï†ÏÎ½Î±Î¾Îµ BINGO! " + (data.winner ? "ÎˆÎ³ÎºÏ…ÏÎ¿!" : "Î”ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î­Î³ÎºÏ…ÏÎ¿."));
  }

  if (data.type === "reset") {
    document.getElementById("drawn").innerHTML = "";
    document.getElementById("number").innerText = "â€“";
    renderPlayers([]);
  }
};

/* === AUTO DRAW === */
async function autoDraw(){
  // Î”ÎµÎ½ ÎºÎ±Î»Î¿ÏÎ¼Îµ show ÎµÎ´Ï, Ï„Î¿ WebSocket Î¸Î± ÎµÎ½Î·Î¼ÎµÏÏÏƒÎµÎ¹ ÏŒÎ»Î¿Ï…Ï‚
  await fetch("/api/draw").then(r => r.json());
}

function startAuto(){
  fetch("/api/start", { method: "POST" });
  if (auto) clearInterval(auto);
  auto = setInterval(autoDraw, 5000);
}

function stopAuto(){
  fetch("/api/stop", { method: "POST" });
  clearInterval(auto);
}

/* === RESET === */
function resetGame(){
  fetch("/api/reset", { method: "POST" });
}

/* === UPDATE UI ÎšÎ›Î—Î¡Î©Î£Î—Î£ === */
function show(n, arr){
  const num = document.getElementById("number");
  num.innerText = n;

  // Zoom animation
  num.classList.add("zoom");
  setTimeout(() => num.classList.remove("zoom"), 300);

  // Play sound
  document.getElementById("sound").play();

  // Update drawn numbers
  const d = document.getElementById("drawn");
  d.innerHTML = "";
  arr.forEach(x=>{
    const b=document.createElement("div");
    b.className="ball"; 
    b.innerText=x;
    d.appendChild(b);
  });
}

/* === Î Î™ÎÎ‘ÎšÎ‘Î£ Î Î‘Î™ÎšÎ¤Î©Î === */
function renderPlayers(players){
  const tbody = document.getElementById("playersBody");
  tbody.innerHTML = "";

  players.forEach(p => {
    const tr = document.createElement("tr");
    if (p.winner) tr.classList.add("winnerRow");

    const tdName = document.createElement("td");
    tdName.textContent = p.name;

    const tdHits = document.createElement("td");
    tdHits.textContent = `${p.hits}/${p.total}`;

    const tdProg = document.createElement("td");
    tdProg.textContent = p.progress + "%";

    const tdStatus = document.createElement("td");
    tdStatus.textContent = p.winner ? "Bingo!" : "Î Î±Î¯Î¶ÎµÎ¹";

    tr.appendChild(tdName);
    tr.appendChild(tdHits);
    tr.appendChild(tdProg);
    tr.appendChild(tdStatus);

    tbody.appendChild(tr);
  });
}

/* === CREATE TICKET === */
async function createTicket(){
  const name = document.getElementById("name").value;

  const r = await fetch("/api/ticket",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name})
  }).then(r=>r.json());

  const link = location.origin + "/ticket.html?ticketId=" + r.ticketId;
  QRCode.toCanvas(document.getElementById("qr"), link);
}
</script>

</body>
</html>
